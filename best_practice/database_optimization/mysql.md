# 最佳实践

## 数据库优化 - Mysql

### 常见的简单DDL DML调优

主要涉及SQL。索引是否命中，表结构设计是否合理，主键，外键，EXPLAIN

#### 表结构优化

设计表结构时，就需要考虑如何设计才能够更有效的查询。

1、选择合适的数据类型

- （1）使用可存下数据的最小的数据类型。
- （2）使用简单地数据类型，int要比varchar类型在mysql处理上更简单。
- （3）尽可能使用not null定义字段，这是由innodb的特性决定的，因为非not null的数据可能需要一些额外的字段进行存储，这样就会增加一些IO。可以对非null的字段设置一个默认值。
- （4）尽量少用text，非用不可最好分表，将text字段存放到另一张表中，在需要的时候再使用联合查询，这样可提高查询主表的效率。

表的设计合理化，符合三大范式（3NF)

- 1NF是对属性的原子性约束，要求属性(列)具有原子性，不可再分解；(只要是关系型数据库都满足1NF)
- 2NF是对记录的惟一性约束，要求记录有惟一标识，即实体的惟一性；
- 3NF是对字段冗余性的约束，它要求字段没有冗余。 没有冗余的数据库设计可以做到。

选择索引

（1）选择合适的索引列 选择在where，group by，order by，on从句中出现的列作为索引项，对于离散度不大的列没有必要创建索引。
（2）索引字段越小越好(因为数据库的存储单位是页，一页中能存下的数据越多越好 )
（3）离散度大得列放在联合索引前面。判断离散程度的方法是： `select count(distinct ziduan1),count(distinct ziduan2) from tablename` 越大越离散

2、索引优化方法

索引一般情况下都是高效的。不过凡是都有两面性，索引是以空间换时间的一种策略，索引本身在提高查询效率的同时会影响插入、更新、删除的效率。不当的使用索引不仅增加了写操作的担，也会影响读取的效率。索引越多，数据库分析的越慢。注意点：
（1）InnoDB 每个索引都会加上主键，联合索引不要加上主键，innodb会自动加，否则会冗余。
（2）索引存在的目的是为了加快查询的效率，不过不是索引越多越好，建立索引要适当才好。过多的索引会增加数据库判断使用什么索引来查询的开销，所以，有时候也会出现以去掉重复或者无效的索引为优化手段的优化方式。
（3）主键已经是索引了，所以primay key 的主键不用再设置unique唯一索引了

#### SQL优化

通过慢查询日志发现有效率问题的SQL

SQL以及索引的优化是最重要的。首先要根据需求写出结构良好的SQL，然后根据SQL在表中建立有效的索引。但是如果索引太多，不但会影响写入的效率，对查询也有一定的影响。

- 通过show status命令了解各种SQL的执行频率；
- 定位执行效率较低的SQL语句-（重点select；
- 通过explain分析低效率的SQL；
- 确定问题并采取相应的优化措施

索引优化。选择合适的列建立索引，一般在where从句，on从句等；维护索引，去掉重复索引 ，如 primary key 不要在加上唯一索引了

#### Mysql配置调优

#### 硬件优化

更快的IO、更多的内存

CPU：CPU并不是越多越好，之前看到网上的分析有说很多的查询都是单CPU的，增加CPU数量并不能提高性能。

存储：机械磁盘 or SSD（当然是SSD更快）；单个大磁盘 or 多个小磁盘组合使用（单个1T的磁盘应该没有2个500G磁盘的组合快，因为磁盘的转速都是固定的，两个磁盘相当于可以并的读取）

网络：一般不是问题，但是在分布式的集群环境中，各个数据库节点之间的网络环境经常会称为系统的瓶颈。另外，如果服务端和数据库分布在不同的城市，一条简单SQL传输的时间可能就几十毫秒。

#### 中间件调优